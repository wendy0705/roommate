<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>室友偏好表單</title>
    <style>
        button {
            margin: 5px;
            padding: 10px 20px;
            border: 2px solid #ccc;
            background-color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }

        button:focus {
            outline: none;
        }

        button.selected, button:active, button:focus {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .hidden {
            display: none;
        }

        label {
            font-weight: bold;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>

</head>
<body>
<h1>生活習慣及偏好</h1>
<form id="preferencesForm">
    <!-- 是否同住 -->
    <label>是否要與人同住一間房間：</label><br>
    <input type="radio" name="share_room" value="1" checked> 是
    <input type="radio" name="share_room" value="0"> 否
    <br><br>

    <!-- 特殊房屋狀況 -->
    <label>可以接受房屋的特殊情況：</label><br>
    <input type="checkbox" name="special_conditions[haunted_house]" value="1"> 凶宅
    <input type="checkbox" name="special_conditions[rooftop_extension]" value="1"> 頂加
    <input type="checkbox" name="special_conditions[illegal_building]" value="1"> 違建
    <input type="checkbox" name="special_conditions[basement]" value="1" checked> 地下室
    <input type="checkbox" name="special_conditions[windowless]" value="1" checked> 無窗
    <br><br>

    <div id="regularSchedule">
        <label>平日作息：</label><br>
        睡眠時間：
        <select class="hour-select" name="schedule[weekday_sleep_hour]"></select>
        起床時間：
        <select class="hour-select" name="schedule[weekday_wake_hour]"></select>
        <br><br>

        <label>假日作息：</label><br>
        睡眠時間：
        <select class="hour-select" name="schedule[weekend_sleep_hour]"></select>
        起床時間：
        <select class="hour-select" name="schedule[weekend_wake_hour]"></select>
        <br><br>
    </div>

    <!-- 按鈕展開自由填寫作息 -->
    <button type="button" id="customScheduleButton" onclick="toggleCustomSchedule()">自由填寫作息</button>
    <br><br>

    <div id="customSchedule" class="hidden">
        <!-- 自由填寫的作息 -->
        <label>週一：</label>
        睡眠時間：
        <select class="hour-select" name="schedule[monday_sleep_hour]"></select>
        起床時間：
        <select class="hour-select" name="schedule[monday_wake_hour]"></select>
        <br><br>

        <label>週二：</label>
        睡眠時間：
        <select class="hour-select" name="schedule[tuesday_sleep_hour]"></select>
        起床時間：
        <select class="hour-select" name="schedule[tuesday_wake_hour]"></select>
        <br><br>

        <label>週三：</label>
        睡眠時間：
        <select class="hour-select" name="schedule[wednesday_sleep_hour]"></select>
        起床時間：
        <select class="hour-select" name="schedule[wednesday_wake_hour]"></select>
        <br><br>

        <label>週四：</label>
        睡眠時間：
        <select class="hour-select" name="schedule[thursday_sleep_hour]"></select>
        起床時間：
        <select class="hour-select" name="schedule[thursday_wake_hour]"></select>
        <br><br>

        <label>週五：</label>
        睡眠時間：
        <select class="hour-select" name="schedule[friday_sleep_hour]"></select>
        起床時間：
        <select class="hour-select" name="schedule[friday_wake_hour]"></select>
        <br><br>

        <label>週六：</label>
        睡眠時間：
        <select class="hour-select" name="schedule[saturday_sleep_hour]"></select>
        起床時間：
        <select class="hour-select" name="schedule[saturday_wake_hour]"></select>
        <br><br>

        <label>週日：</label>
        睡眠時間：
        <select class="hour-select" name="schedule[sunday_sleep_hour]"></select>
        起床時間：
        <select class="hour-select" name="schedule[sunday_wake_hour]"></select>
        <br><br>
    </div>

    <!-- 開伙地點 -->
    <label>開伙地點：</label><br>
    <input type="radio" name="cooking_location" value="1"> 會開伙
    <input type="radio" name="cooking_location" value="0"> 不會開伙
    <br><br>

    <!-- 用餐地點 -->
    <label>用餐地點：</label><br>
    <input type="radio" name="dining_location" value="1"> 會在家用餐
    <input type="radio" name="dining_location" value="0"> 不會在家用餐
    <br><br>

    <!-- 用餐習慣 -->
    <label>用餐習慣：</label><br>
    <input type="checkbox" name="dining_habits[alone]" value="1"> 自己吃
    <input type="checkbox" name="dining_habits[not_alone]" value="1"> 跟朋友吃
    <br><br>

    <!-- 噪音 -->
    <label>噪音敏感度：（1-5分，5分代表非常需要安靜的環境）</label><br>
    入睡：<input type="number" name="noise_sensitivity[sleep]" min="1" max="5" value="5">
    學習或工作：<input type="number" name="noise_sensitivity[study_or_work]" min="1" max="5" value="3">
    <br><br>

    <!-- 鬧鐘使用習慣 -->
    <label>鬧鐘使用習慣：</label><br>
    <button type="button" value="0" data-group="alarm" onclick="toggleButtonGroup(this)">#不使用</button>
    <button type="button" value="1" data-group="alarm" onclick="toggleButtonGroup(this)">#響一下關閉</button>
    <button type="button" value="2" data-group="alarm" onclick="toggleButtonGroup(this)">#需要他人協助關閉</button>
    <br><br>

    <label>燈光敏感度：</label><br>
    <button type="button" value="0" data-group="light" onclick="toggleButtonGroup(this)">#開大燈</button>
    <button type="button" value="1" data-group="light" onclick="toggleButtonGroup(this)">#開小燈</button>
    <button type="button" value="2" data-group="light" onclick="toggleButtonGroup(this)">#全暗</button>
    <br><br>

    <label>交友習慣：</label><br>
    <button type="button" value="0" data-group="friendship" onclick="toggleButtonGroup(this)">#不會帶朋友回家</button>
    <button type="button" value="1" data-group="friendship" onclick="toggleButtonGroup(this)">#可能會帶朋友回家</button>
    <button type="button" value="2" data-group="friendship" onclick="toggleButtonGroup(this)">#會帶朋友回家</button>
    <br><br>

    <label>天氣熱時：</label><br>
    <button type="button" value="0" data-group="weather" onclick="toggleButtonGroup(this); toggleTemperatureInput()">
        #不開冷氣
    </button>
    <button type="button" value="1" data-group="weather" onclick="toggleButtonGroup(this); toggleTemperatureInput()">
        #不常開冷氣
    </button>
    <button type="button" value="2" data-group="weather" onclick="toggleButtonGroup(this); toggleTemperatureInput()">
        #只有晚上睡覺開
    </button>
    <button type="button" value="3" data-group="weather" onclick="toggleButtonGroup(this); toggleTemperatureInput()">
        #會開冷氣
    </button>
    <div id="temperature_input" class="hidden">
        <label>冷氣溫度：</label><input type="number" name="hot_weather_preference[temperature]" min="16" max="30"
                                       placeholder="輸入溫度">
    </div>
    <br><br>

    <!-- 寵物 -->
    <label>寵物：</label><br>
    <input type="radio" name="has_pet" value="0" onclick="togglePetType()"> 無
    <input type="radio" name="has_pet" value="1" onclick="togglePetType()"> 有
    <div id="pet_type_input" class="hidden">
        <label>寵物種類：</label><input type="text" name="pet[pet_type]" placeholder="例如：狗">
    </div>
    <br><br>

    <label>濕度高時：</label><br>
    <button type="button" value="0" data-group="humidity" onclick="toggleButtonGroup(this)">#不開除濕</button>
    <button type="button" value="1" data-group="humidity" onclick="toggleButtonGroup(this)">#不常開除溼</button>
    <button type="button" value="2" data-group="humidity" onclick="toggleButtonGroup(this)">#會開除濕</button>
    <br><br>

    <label>興趣：</label><br>
    <button type="button" value="sports" data-group="interest" onclick="toggleButtonGroup(this)">#運動</button>
    <button type="button" value="travel" data-group="interest" onclick="toggleButtonGroup(this)">#旅遊</button>
    <button type="button" value="reading" data-group="interest" onclick="toggleButtonGroup(this)">#閱讀</button>
    <button type="button" value="wine_tasting" data-group="interest" onclick="toggleButtonGroup(this)">#品酒</button>
    <button type="button" value="drama" data-group="interest" onclick="toggleButtonGroup(this)">#追劇</button>
    <button type="button" value="astrology" data-group="interest" onclick="toggleButtonGroup(this)">#占星</button>
    <button type="button" value="programming" data-group="interest" onclick="toggleButtonGroup(this)">#寫程式</button>
    <button type="button" value="hiking" data-group="interest" onclick="toggleButtonGroup(this)">#登山</button>
    <button type="button" value="gaming" data-group="interest" onclick="toggleButtonGroup(this)">#遊戲</button>
    <button type="button" value="painting" data-group="interest" onclick="toggleButtonGroup(this)">#繪畫</button>
    <button type="button" value="idol_chasing" data-group="interest" onclick="toggleButtonGroup(this)">#追星</button>
    <button type="button" value="music" data-group="interest" onclick="toggleButtonGroup(this)">#音樂</button>
    <br><br>


    <!-- 室友期望 -->
    <!--    <label>我希望我的室友：</label><br>-->
    <!--    <textarea name="roommate_expectation" maxlength="30" placeholder="請輸入最多30字..."></textarea>-->
    <!--    <br><br>-->

    <!-- 提交 -->
    <button type="submit">送出</button>
</form>
<script>
    function getCookieValue(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    let matchingUserIds;

    document.addEventListener('DOMContentLoaded', function () {

        matchingUserIds = JSON.parse(localStorage.getItem('matchingUserIds')) || [];

        console.log('Matching User IDs:', matchingUserIds);
    });

    function toggleButtonGroup(button) {
        const group = button.getAttribute('data-group'); // 獲取按鈕的 data-group 屬性

        // 如果是 "interest" 組，則允許多選
        if (group === "interest") {
            // 切換選中狀態
            if (button.classList.contains('selected')) {
                button.classList.remove('selected'); // 如果已選中，則取消選中
            } else {
                button.classList.add('selected'); // 如果未選中，則添加選中狀態
            }
        } else {
            // 如果不是 "interest" 組，則保持單選行為
            const buttons = document.querySelectorAll(`button[data-group="${group}"]`); // 選取同一組的按鈕

            // 清除該組按鈕的選中狀態
            buttons.forEach(btn => {
                btn.classList.remove('selected');
            });

            // 設定當前按鈕為選中狀態
            button.classList.add('selected');
        }
    }


    function toggleTemperatureInput() {
        const temperatureInputDiv = document.getElementById("temperature_input");
        const temperatureInputField = temperatureInputDiv.querySelector('input[name="hot_weather_preference[temperature]"]');
        const selectedWeatherButton = document.querySelector('button[data-group="weather"].selected');

        if (selectedWeatherButton && selectedWeatherButton.value == "3") {
            // 顯示冷氣溫度輸入框
            temperatureInputDiv.classList.remove("hidden");
        } else {
            // 隱藏冷氣溫度輸入框並清空輸入值
            temperatureInputDiv.classList.add("hidden");
            temperatureInputField.value = ""; // 清空溫度輸入框的值
        }
    }

    function togglePetType() {
        const petTypeInputDiv = document.getElementById("pet_type_input");
        const petTypeInputField = petTypeInputDiv.querySelector('input[name="pet[pet_type]"]'); // 選取輸入框
        const petSelection = document.querySelector('input[name="has_pet"]:checked').value;
        if (petSelection == "1") {
            petTypeInputDiv.classList.remove("hidden"); // 顯示寵物種類的輸入框
        } else {
            petTypeInputDiv.classList.add("hidden"); // 隱藏寵物種類的輸入框
            petTypeInputField.value = ""; // 清空輸入框的值
        }
    }

    function createHourOptions() {
        let options = '<option value="" selected>時</option>';
        for (let i = 0; i <= 23; i++) {
            options += `<option value="${i}">${i}</option>`;
        }
        return options;
    }

    function insertHourOptions() {
        const selects = document.querySelectorAll('.hour-select');
        const options = createHourOptions();
        selects.forEach(select => {
            select.innerHTML = options;
        });
    }

    function checkTimeSelection() {
        const weekdaySleep = document.querySelector('select[name="schedule[weekday_sleep_hour]"]').value;
        const weekdayWake = document.querySelector('select[name="schedule[weekday_wake_hour]"]').value;
        const weekendSleep = document.querySelector('select[name="schedule[weekend_sleep_hour]"]').value;
        const weekendWake = document.querySelector('select[name="schedule[weekend_wake_hour]"]').value;

        const customScheduleButton = document.getElementById("customScheduleButton");

        if (weekdaySleep === "" && weekdayWake === "" && weekendSleep === "" && weekendWake === "") {
            // 平日和假日都沒有選擇時數，解鎖按鈕
            customScheduleButton.disabled = false;
        } else {
            // 只要有選擇時數，就禁用按鈕
            customScheduleButton.disabled = true;
        }
    }

    function toggleCustomSchedule() {
        const customScheduleDiv = document.getElementById("customSchedule");
        const regularScheduleDiv = document.getElementById("regularSchedule"); // 包含平日和假日作息區塊
        const customSelects = customScheduleDiv.querySelectorAll('select'); // 選取所有的 <select> 元素

        if (customScheduleDiv.classList.contains("hidden")) {
            // 顯示自定義作息區域，隱藏平日和假日作息區域
            customScheduleDiv.classList.remove("hidden");
            regularScheduleDiv.classList.add("hidden");
        } else {
            // 隱藏自定義作息區域，顯示平日和假日作息區域，並清空自定義作息選項
            customScheduleDiv.classList.add("hidden");
            regularScheduleDiv.classList.remove("hidden");

            // 清空所有 <select> 的值
            customSelects.forEach(select => {
                select.value = ""; // 清空每個 <select> 的值
            });
        }
    }

    window.onload = function () {
        insertHourOptions();
        const timeSelects = document.querySelectorAll('.hour-select');
        timeSelects.forEach(select => {
            select.addEventListener('change', checkTimeSelection);
        });
    }

    document.getElementById('preferencesForm').addEventListener('submit', function (event) {
        event.preventDefault(); // 防止表單提交刷新頁面

        // 1. 收集資料
        const formData = new FormData(this);
        const myId = getCookieValue('userId')

        let schedule = {
            monday: [formData.get('schedule[monday_sleep_hour]') || formData.get('schedule[weekday_sleep_hour]'), formData.get('schedule[monday_wake_hour]') || formData.get('schedule[weekday_wake_hour]')],
            tuesday: [formData.get('schedule[tuesday_sleep_hour]') || formData.get('schedule[weekday_sleep_hour]'), formData.get('schedule[tuesday_wake_hour]') || formData.get('schedule[weekday_wake_hour]')],
            wednesday: [formData.get('schedule[wednesday_sleep_hour]') || formData.get('schedule[weekday_sleep_hour]'), formData.get('schedule[wednesday_wake_hour]') || formData.get('schedule[weekday_wake_hour]')],
            thursday: [formData.get('schedule[thursday_sleep_hour]') || formData.get('schedule[weekday_sleep_hour]'), formData.get('schedule[thursday_wake_hour]') || formData.get('schedule[weekday_wake_hour]')],
            friday: [formData.get('schedule[friday_sleep_hour]') || formData.get('schedule[weekday_sleep_hour]'), formData.get('schedule[friday_wake_hour]') || formData.get('schedule[weekday_wake_hour]')],
            saturday: [formData.get('schedule[saturday_sleep_hour]') || formData.get('schedule[weekend_sleep_hour]'), formData.get('schedule[saturday_wake_hour]') || formData.get('schedule[weekend_wake_hour]')],
            sunday: [formData.get('schedule[sunday_sleep_hour]') || formData.get('schedule[weekend_sleep_hour]'), formData.get('schedule[sunday_wake_hour]') || formData.get('schedule[weekend_wake_hour]')]
        };

        // 2. 構建 JSON 對象
        const my_preference = {
            share_room: formData.get('share_room'),
            special_conditions: {
                haunted_house: formData.get('special_conditions[haunted_house]') ? 1 : 0,
                rooftop_extension: formData.get('special_conditions[rooftop_extension]') ? 1 : 0,
                illegal_building: formData.get('special_conditions[illegal_building]') ? 1 : 0,
                basement: formData.get('special_conditions[basement]') ? 1 : 0,
                windowless: formData.get('special_conditions[windowless]') ? 1 : 0
            },
            schedule: schedule,
            cooking_location: formData.get('cooking_location'),
            dining_location: formData.get('dining_location'),
            dining_habits: {
                alone: formData.get('dining_habits[alone]') ? 1 : 0,
                not_alone: formData.get('dining_habits[not_alone]') ? 1 : 0
            },
            noise_sensitivity: {
                sleep: formData.get('noise_sensitivity[sleep]'),
                study_or_work: formData.get('noise_sensitivity[study_or_work]')
            },
            alarm_habit: document.querySelector('button[data-group="alarm"].selected')?.value || 0,
            light_sensitivity: document.querySelector('button[data-group="light"].selected')?.value || 0,
            friendship_habit: document.querySelector('button[data-group="friendship"].selected')?.value || 0,
            hot_weather_preference: {
                preference: document.querySelector('button[data-group="weather"].selected')?.value || 0,
                temperature: formData.get('hot_weather_preference[temperature]')
            },
            humidity_preference: document.querySelector('button[data-group="humidity"].selected')?.value || 0,
            pet: {
                has_pet: formData.get('has_pet'),
                pet_type: formData.get('pet[pet_type]')
            },
            interest: {
                sports: document.querySelector('button[value="sports"].selected') ? 1 : 0,
                travel: document.querySelector('button[value="travel"].selected') ? 1 : 0,
                reading: document.querySelector('button[value="reading"].selected') ? 1 : 0,
                wine_tasting: document.querySelector('button[value="wine_tasting"].selected') ? 1 : 0,
                drama: document.querySelector('button[value="drama"].selected') ? 1 : 0,
                astrology: document.querySelector('button[value="astrology"].selected') ? 1 : 0,
                programming: document.querySelector('button[value="programming"].selected') ? 1 : 0,
                hiking: document.querySelector('button[value="hiking"].selected') ? 1 : 0,
                gaming: document.querySelector('button[value="gaming"].selected') ? 1 : 0,
                painting: document.querySelector('button[value="painting"].selected') ? 1 : 0,
                idol_chasing: document.querySelector('button[value="idol_chasing"].selected') ? 1 : 0,
                music: document.querySelector('button[value="music"].selected') ? 1 : 0
            },
            matching_user_ids: matchingUserIds
        };

        // 3. 測試輸出
        console.log(JSON.stringify(my_preference, null, 2)); // 測試時輸出到控制台

        console.log(myId);

        if (Array.isArray(matchingUserIds)) {
            // 處理 List<Long>，發送到 rented 的 API
            fetch(`/api/1.0/analysis/rented/match?myId=${myId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    my_preference,
                    matching_user_ids: matchingUserIds
                }),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Fetched data:', data);

                    localStorage.setItem('matchResults', JSON.stringify(data));

                    window.location.href = '/rented-matched';
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        } else if (typeof matchingUserIds === 'object' && matchingUserIds !== null) {

            fetch(`/api/1.0/analysis/not-rented/match?myId=${myId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    my_preference,
                    matching_user_ids: matchingUserIds
                }),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Fetched data:', data);

                    localStorage.setItem('matchResults', JSON.stringify(data));

                    window.location.href = '/not-rented-matched';
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        } else {
            console.log('Invalid data format for matchingUserIds.');
        }

        // fetch(`/api/1.0/analysis/rented/match?myId=${myId}`, { // 將 myId 作為請求參數
        //     method: 'POST',
        //     headers: {
        //         'Content-Type': 'application/json',
        //     },
        //     body: JSON.stringify({
        //         my_preference,  // 傳遞 my_preference 作為 JSON 屬性
        //         matching_user_ids: matchingUserIds
        //     }),// 發送表單數據作為 JSON 格式
        // })
        //     .then(response => response.json())
        //     .then(data => {
        //         console.log('Fetched data:', data);
        //
        //         // 將數據存儲在 localStorage 中
        //         localStorage.setItem('matchResults', JSON.stringify(data));
        //
        //         // 跳轉到結果頁面
        //         window.location.href = '/rented-matched';
        //     })
        //     .catch((error) => {
        //         console.error('Error:', error);
        //     });
    });

</script>
</body>
</html>

